<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>プロジェクト管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <div class="container">
        
        
        <!-- 簡易検索 -->
        <section class="mb-5">
            <h2 class="search-title mt-4 mb-4">簡易検索</h2>
            <form id="simpleSearchForm" th:action="@{/search}" method="get" th:object="${searchForm}" class="mb-4" onsubmit="return handleSearchSubmit(event, 'simple')">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="projectName" class="form-label">プロジェクト名</label>
                        <input type="text" class="form-control" id="projectName" th:field="*{projectName}">
                    </div>
                    <div class="col-md-4">
                        <label for="salesUserName" class="form-label">営業担当者</label>
                        <input type="text" class="form-control" id="salesUserName" th:field="*{salesUserName}">
                    </div>
                    <div class="col-md-4">
                        <label for="projectManagerName" class="form-label">プロジェクトマネージャー</label>
                        <input type="text" class="form-control" id="projectManagerName" th:field="*{projectManagerName}">
                    </div>
                    <div class="col-md-4">
                        <label for="wbsNo" class="form-label">WBS番号</label>
                        <input type="text" class="form-control" id="wbsNo" th:field="*{wbsNo}">
                    </div>
                    <div class="col-md-4">
                        <label for="wbsName" class="form-label">WBS名</label>
                        <input type="text" class="form-control" id="wbsName" th:field="*{wbsName}">
                    </div>
                    <div class="col-md-4">
                        <label for="engineerName" class="form-label">エンジニア名</label>
                        <input type="text" class="form-control" id="engineerName" th:field="*{engineerName}">
                    </div>
                    <div class="col-md-4">
                        <label for="contractDateFrom" class="form-label">契約年月日（開始）</label>
                        <input type="date" class="form-control" id="contractDateFrom" th:field="*{contractDateFrom}">
                    </div>
                    <div class="col-md-4">
                        <label for="contractDateTo" class="form-label">契約年月日（終了）</label>
                        <input type="date" class="form-control" id="contractDateTo" th:field="*{contractDateTo}">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">検索</button>
                        <button type="reset" class="btn btn-secondary">クリア</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- 詳細検索 -->
        <section>
            <!-- エラーメッセージ表示エリア -->
            <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
            <h2 class="search-title mb-4">詳細検索</h2>
            <div class="card">
                <div class="card-body">
                    <!-- CSVファイルインポート部分 -->
                    <div class="mb-4">
                        <h5>検索条件CSVインポート</h5>
                        <div>
                            <label class="btn btn-outline-secondary" for="csvFileInput">
                                CSVファイルを選択してインポート
                            </label>
                            <input type="file" class="d-none" id="csvFileInput" accept=".csv">
                        </div>
                        <div id="csvFileHelp" class="form-text">
                            CSVファイル形式: 検索項目,検索値,比較演算子,論理演算子
                        </div>
                    </div>

                    <form id="advancedSearchForm" th:action="@{/search/advanced}" method="get" class="mb-4" onsubmit="return handleSearchSubmit(event, 'advanced')">
                        <div id="searchConditions">
                            <!-- 検索条件テンプレート -->
                            <div class="search-condition row g-3 mb-3">
                                <div class="col-md-3">
                                    <select class="form-select search-field" name="fields[]">
                                        <option value="">-</option>
                                        <option value="project_name">プロジェクト名</option>
                                        <option value="sales_user_name">営業担当者</option>
                                        <option value="project_manager_name">プロジェクトマネージャー</option>
                                        <option value="wbs_no">WBS番号</option>
                                        <option value="wbs_name">WBS名</option>
                                        <option value="engineer_name">エンジニア名</option>
                                        <option value="contract_date">契約年月日</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control search-value" name="values[]" placeholder="検索値">
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select search-comparison" name="comparisons[]">
                                        <option value="contains">を含む</option>
                                        <option value="startsWith">から始まる</option>
                                        <option value="endsWith">で終わる</option>
                                        <option value="equals">と一致する</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select search-operator" name="operators[]">
                                        <option value="AND">AND</option>
                                        <option value="OR">OR</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger remove-condition">削除</button>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-secondary" id="addCondition">条件を追加</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">検索</button>
                                <button type="button" class="btn btn-success" onclick="downloadCSV()">CSV出力</button>
                                <button type="reset" class="btn btn-secondary">クリア</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <!-- 検索結果件数確認モーダル -->
    <div class="modal fade" id="searchCountModal" tabindex="-1" aria-labelledby="searchCountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchCountModalLabel">検索結果確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="searchCountModalBody">
                    <!-- ここに検索件数が動的に表示されます -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">検索条件を修正</button>
                    <button type="button" class="btn btn-primary" id="proceedSearchBtn">検索結果を表示</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 定数の集約
        const CONSTANTS = {
            ERROR_DISPLAY_DURATION: 5000,
            SUCCESS_DISPLAY_DURATION: 3000,
            VALID_FIELDS: [
                'プロジェクト名', '営業担当者', 'プロジェクトマネージャー',
                'WBS番号', 'WBS名', 'エンジニア名', '契約年月日'
            ],
            VALID_COMPARISONS: [
                'を含む', 'から始まる', 'で終わる', 'と一致する',
                'より後', 'より前', '以降', '以前'
            ],
            VALID_OPERATORS: ['AND', 'OR', ''],
            CSV_EXPECTED_HEADER: '検索項目,検索値,比較演算子,論理演算子'
        };

        // ユーティリティ関数
        const utils = {
            showMessage: function(message, isError = true) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3';
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                    if (!isError) {
                        errorDiv.className = 'alert alert-danger mt-3';
                    }
                }, isError ? CONSTANTS.ERROR_DISPLAY_DURATION : CONSTANTS.SUCCESS_DISPLAY_DURATION);
            },

            validateSearchConditions: function(form) {
                const fields = Array.from(form.querySelectorAll('.search-field')).map(f => f.value);
                const values = Array.from(form.querySelectorAll('.search-value')).map(v => v.value);
                
                if (fields.some(f => !f)) {
                    this.showMessage('検索項目を選択してください');
                    return false;
                }
                if (values.some(v => !v.trim())) {
                    this.showMessage('検索値を入力してください');
                    return false;
                }
                return true;
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const searchConditions = document.getElementById('searchConditions');
            const addConditionBtn = document.getElementById('addCondition');
            const csvFileInput = document.getElementById('csvFileInput');
            let currentForm = null;
            const searchCountModal = new bootstrap.Modal(document.getElementById('searchCountModal'));

            // 検索条件の追加・削除のイベントハンドラ
            function handleConditionManagement() {
                // 条件追加ボタンのクリックイベント
                addConditionBtn.addEventListener('click', function() {
                    const template = searchConditions.querySelector('.search-condition').cloneNode(true);
                    resetSearchCondition(template);
                    searchConditions.appendChild(template);
                    attachRemoveHandler(template.querySelector('.remove-condition'));
                });

                // 初期の削除ボタンにイベントリスナーを追加
                attachRemoveHandler(document.querySelector('.remove-condition'));
            }

            function resetSearchCondition(template) {
                template.querySelector('.search-value').value = '';
                template.querySelector('.search-field').selectedIndex = 0;
                template.querySelector('.search-comparison').selectedIndex = 0;
                template.querySelector('.search-operator').selectedIndex = 0;
            }

            function attachRemoveHandler(button) {
                button.addEventListener('click', function() {
                    if (searchConditions.children.length > 1) {
                        this.closest('.search-condition').remove();
                    }
                });
            }

            // 検索フォームの送信処理
            async function handleSearchSubmit(event, type) {
                event.preventDefault();
                const form = event.target;
                currentForm = form;

                if (type === 'advanced' && !utils.validateSearchConditions(form)) {
                    return;
                }

                try {
                    const url = type === 'simple' ? '/search/count' : '/search/advanced/count';
                    const formData = new FormData(form);
                    const params = new URLSearchParams(formData);

                    const response = await fetch(`${url}?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error('検索処理でエラーが発生しました');
                    }
                    const html = await response.text();
                    document.getElementById('searchCountModalBody').innerHTML = html;
                    searchCountModal.show();
                } catch (error) {
                    utils.showMessage(error.message);
                }
            }

            // 検索実行ボタンのイベントリスナー
            document.getElementById('proceedSearchBtn').addEventListener('click', () => {
                if (currentForm) {
                    currentForm.target = '_blank';
                    currentForm.submit();
                    searchCountModal.hide();
                }
            });

            // フォームのイベントリスナー設定
            ['simpleSearchForm', 'advancedSearchForm'].forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', (e) => 
                        handleSearchSubmit(e, formId === 'simpleSearchForm' ? 'simple' : 'advanced')
                    );
                }
            });

            // 契約年月日フィールド変更時の処理
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('search-field')) {
                    updateComparisonOptions(e.target);
                }
            });

            function updateComparisonOptions(fieldSelect) {
                const comparisonSelect = fieldSelect.closest('.search-condition').querySelector('.search-comparison');
                if (fieldSelect.value === 'contract_date') {
                    comparisonSelect.innerHTML = `
                        <option value="equals">と一致する</option>
                        <option value="greater">より後</option>
                        <option value="less">より前</option>
                        <option value="greaterOrEqual">以降</option>
                        <option value="lessOrEqual">以前</option>
                    `;
                } else {
                    comparisonSelect.innerHTML = `
                        <option value="contains">を含む</option>
                        <option value="startsWith">から始まる</option>
                        <option value="endsWith">で終わる</option>
                        <option value="equals">と一致する</option>
                    `;
                }
            }

            // 初期化
            handleConditionManagement();
        });

        // CSV関連の処理
        async function downloadCSV() {
            const form = document.getElementById('advancedSearchForm');
            const searchValues = form.querySelectorAll('.search-value');
            
            if (Array.from(searchValues).some(input => !input.value.trim())) {
                utils.showMessage('検索条件の入力値が未入力の項目があります。全ての検索条件に値を入力してください。');
                return;
            }

            try {
                const params = new URLSearchParams();
                ['fields', 'values', 'comparisons', 'operators'].forEach(param => {
                    const elements = form.querySelectorAll(`.search-${param.slice(0, -1)}`);
                    Array.from(elements).forEach((el, i) => {
                        if (param !== 'operators' || i < elements.length - 1) {
                            params.append(param, el.value);
                        }
                    });
                });

                const response = await fetch(`/search/advanced/csv?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(await response.text());
                }

                const blob = await response.blob();
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const defaultFilename = `searchProject_${today}.csv`;

                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: defaultFilename,
                        types: [{
                            description: 'CSV File',
                            accept: {
                                'text/csv': ['.csv'],
                            },
                        }],
                    });

                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();

                } catch (err) {
                    if (err.name !== 'AbortError') {
                        throw err;
                    }
                }
            } catch (error) {
                console.error('CSVのダウンロードに失敗しました:', error);
                utils.showMessage(`CSVのダウンロードに失敗しました: ${error.message}`);
            }
        }
    </script>
</body>
</html>