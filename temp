var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/", async (HttpContext context) =>
{
    var user = context.User?.Identity?.Name ?? "anonymous";

    using var client = new HttpClient();
    var request = new HttpRequestMessage(HttpMethod.Get, "http://localhost:8080/");
    request.Headers.Add("X-Remote-User", user);

    var response = await client.SendAsync(request);

    context.Response.StatusCode = (int)response.StatusCode;

    // Spring Boot からのヘッダーをコピー（必要に応じて charset や content-type も）
    foreach (var header in response.Headers)
    {
        context.Response.Headers[header.Key] = string.Join(",", header.Value);
    }

    foreach (var header in response.Content.Headers)
    {
        context.Response.Headers[header.Key] = string.Join(",", header.Value);
    }

    // 文字化け防止（明示的に UTF-8 指定）
    context.Response.ContentType = "text/html; charset=utf-8";

    var content = await response.Content.ReadAsByteArrayAsync();
    await context.Response.Body.WriteAsync(content);
});

app.Run();
