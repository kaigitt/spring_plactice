var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.Run(async context =>
{
    var user = context.User?.Identity?.Name ?? "anonymous";

    // クライアントからのリクエストパスとクエリを含めた Spring Boot 宛の URL
    var targetUrl = "http://localhost:8080" + context.Request.Path + context.Request.QueryString;

    using var client = new HttpClient();
    var request = new HttpRequestMessage(new HttpMethod(context.Request.Method), targetUrl);

    // 必要なヘッダー（ユーザーなど）を転送
    request.Headers.Add("X-Remote-User", user);

    // Spring Boot に転送してレスポンスを受け取る
    var response = await client.SendAsync(request);
    var contentBytes = await response.Content.ReadAsByteArrayAsync();

    context.Response.StatusCode = (int)response.StatusCode;

    // レスポンスヘッダーをコピー（Transfer-Encoding は除く）
    foreach (var header in response.Headers)
    {
        if (header.Key.ToLower() != "transfer-encoding")
            context.Response.Headers[header.Key] = string.Join(",", header.Value);
    }
    foreach (var header in response.Content.Headers)
    {
        if (header.Key.ToLower() != "transfer-encoding")
            context.Response.Headers[header.Key] = string.Join(",", header.Value);
    }

    await context.Response.Body.WriteAsync(contentBytes);
});
